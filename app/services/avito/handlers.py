"""–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π Avito."""

from __future__ import annotations

from loguru import logger


class AvitoMessageHandlers:
    """–ë–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π Avito."""

    @staticmethod
    async def handle_text_message(chat_id: str, text: str, author_id: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ RAG."""
        logger.info(
            "Avito: —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ %s –æ—Ç %s: %s",
            chat_id,
            author_id,
            text[:80],
        )

        try:
            # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º RAG engine –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
            from app.services.rag.answer import answer_engine

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ RAG —Å–∏—Å—Ç–µ–º—É
            answer = await answer_engine.generate_answer(text)

            # –ï—Å–ª–∏ RAG –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
            if not answer or answer.strip() == "":
                logger.warning(
                    "RAG –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç –¥–ª—è —á–∞—Ç–∞ %s, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback", chat_id
                )
                return AvitoMessageHandlers._get_fallback_response(text)

            logger.info(
                "RAG –æ—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è —á–∞—Ç–∞ %s (–¥–ª–∏–Ω–∞: %s)", chat_id, len(answer)
            )
            return answer

        except Exception as e:
            logger.error(
                "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ RAG –¥–ª—è —á–∞—Ç–∞ %s: %s", chat_id, e
            )
            return AvitoMessageHandlers._get_fallback_response(text)

    @staticmethod
    def _get_fallback_response(text: str) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ RAG –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."""
        text_lower = text.lower()

        if any(word in text_lower for word in ("–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–¥–æ–±—Ä—ã–π")):
            return (
                "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã\n\n"
                "–Ø ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å–∞.\n\n"
                "–£ –Ω–∞—Å –µ—Å—Ç—å:\n"
                "ü§ñ –ò–ò-–ú–µ–Ω–µ–¥–∂–µ—Ä ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è CRM\n"
                "‚öñÔ∏è –ò–ò-–Æ—Ä–∏—Å—Ç ‚Äî –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\n"
                "üìä –ò–ò-–ê–Ω–∞–ª–∏—Ç–∏–∫ ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö\n\n"
                "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–∞—è –∑–∞–¥–∞—á–∞ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ–¥ –≤–∞–º–∏?"
            )

        if any(
            word in text_lower for word in ("—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "—Å–∫–æ–ª—å–∫–æ", "—Ç–∞—Ä–∏—Ñ")
        ):
            return (
                "üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–∞–¥–∞—á –∏ –æ–±—ä—ë–º–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:\n\n"
                "üì¶ –°—Ç–∞—Ä—Ç ‚Äî –æ—Ç 50 000 ‚ÇΩ\n"
                "üöÄ –û–ø—Ç–∏–º—É–º ‚Äî –æ—Ç 150 000 ‚ÇΩ\n"
                "‚≠ê Enterprise ‚Äî –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ\n\n"
                "–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é, –∏ —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é —Ä–∞—Å—á—ë—Ç!"
            )

        if any(
            word in text_lower
            for word in (
                "–∫–æ–Ω—Ç–∞–∫—Ç",
                "—Å–≤—è–∑—å",
                "—Å–≤—è–∑–∞—Ç—å—Å—è",
                "—Ç–µ–ª–µ—Ñ–æ–Ω",
                "email",
                "telegram",
            )
        ):
            return (
                "üìû –° –Ω–∞–º–∏ –º–æ–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å—Å—è —Ç–∞–∫:\n\n"
                "Telegram: @your_bot\n"
                "Email: sales@example.com\n"
                "–¢–µ–ª–µ—Ñ–æ–Ω: +7 (XXX) XXX-XX-XX\n\n"
                "–ú–æ–∂–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—â–µ–Ω–∏–µ –∏ –∑–¥–µ—Å—å, –µ—Å–ª–∏ —É–¥–æ–±–Ω–æ!"
            )

        return (
            "–°–ø–∞—Å–∏–±–æ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ! üôè\n\n"
            "–Ø –ø–µ—Ä–µ–¥–∞–ª –µ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É ‚Äî –æ–Ω –æ—Ç–≤–µ—Ç–∏—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n"
            "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –∑–∞–¥–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!"
        )

    @staticmethod
    async def handle_image_message(chat_id: str, image_url: str) -> str:
        """–†–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º."""
        logger.info("Avito: –ø–æ–ª—É—á–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —á–∞—Ç–µ %s (%s).", chat_id, image_url)
        return (
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ! üì∑\n\n"
            "–ú—ã –∏–∑—É—á–∏–º –µ–≥–æ –∏ –≤–µ—Ä–Ω—ë–º—Å—è —Å –æ—Ç–≤–µ—Ç–æ–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
        )
