"""Точка входа FastAPI приложения."""

from __future__ import annotations

from collections.abc import AsyncGenerator

from fastapi import FastAPI, HTTPException, Request
from fastapi.exceptions import RequestValidationError
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from loguru import logger

from app import __version__
from app.api.routes.health import router as health_router
from app.core.cache import close_redis, verify_redis
from app.core.config import load_environment
from app.core.database import (
    apply_migrations,
    close_engine,
    verify_database,
)
from app.core.dependencies import authorize_request
from app.core.logging import configure_logging
from app.core.observability import configure_sentry
from app.core.rate_limiter import RateLimitMiddleware
from app.core.settings import settings


UNPROTECTED_PATHS = {
    "/",
    "/health",
    "/ready",
    "/docs",
    "/redoc",
    "/openapi.json",
}


load_environment()


async def lifespan(_: FastAPI) -> AsyncGenerator[None, None]:
    """Управляет жизненным циклом приложения."""
    configure_logging()
    configure_sentry()
    await bootstrap_runtime()
    try:
        yield
    finally:
        await shutdown_runtime()


def create_application() -> FastAPI:
    """Создаёт и настраивает экземпляр FastAPI."""
    app = FastAPI(
        title="Интеллектуальный ассистент продаж ИИ-услуг",
        version=__version__,
        description="Сервис автоматизации продаж ИИ-услуг.",
        lifespan=lifespan,
    )

    # # setup_middlewares(app)
    # register_exception_handlers(app)
    register_routers(app)

    @app.get("/", tags=["health"])
    async def root() -> dict[str, str]:
        """Возвращает статус сервиса."""
        return {
            "status": "ok",
            "message": "Ассистент продаж готов к работе.",
        }

    return app


app = create_application()


def setup_middlewares(app: FastAPI) -> None:
    """Регистрирует middleware для приложения."""
    app.add_middleware(
        CORSMiddleware,
        allow_origins=settings.allowed_origins,
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    app.add_middleware(
        RateLimitMiddleware,
        limit=settings.rate_limit_per_minute,
        window_seconds=settings.rate_limit_window_seconds,
        exempt_paths=UNPROTECTED_PATHS,
    )

    @app.middleware("http")
    async def enforce_jwt(request: Request, call_next):
        """Проверяет JWT для защищённых эндпоинтов."""
        if request.url.path in UNPROTECTED_PATHS:
            return await call_next(request)
        try:
            await authorize_request(request)
        except HTTPException as exc:
            return JSONResponse(
                status_code=exc.status_code,
                content={"detail": exc.detail},
            )
        return await call_next(request)


def register_routers(app: FastAPI) -> None:
    """Подключает все маршруты приложения."""
    app.include_router(health_router)


def register_exception_handlers(app: FastAPI) -> None:
    """Настраивает обработчики ошибок FastAPI."""

    @app.exception_handler(RequestValidationError)
    async def validation_exception_handler(
        request: Request,
        exc: RequestValidationError,
    ) -> JSONResponse:
        """Обрабатывает ошибки валидации запросов."""
        logger.warning(
            "Ошибка валидации для пути {}: {}",
            request.url.path,
            exc.errors(),
        )
        return JSONResponse(
            status_code=422,
            content={
                "detail": exc.errors(),
                "message": "Ошибки проверки данных запроса.",
            },
        )

    @app.exception_handler(Exception)
    async def unhandled_exception_handler(
        request: Request,
        exc: Exception,
    ) -> JSONResponse:
        """Обрабатывает неожиданные исключения."""
        logger.exception(
            "Необработанное исключение для пути {}",
            request.url.path,
        )
        return JSONResponse(
            status_code=500,
            content={"detail": "Внутренняя ошибка сервера."},
        )


async def bootstrap_runtime() -> None:
    """Готовит внешние сервисы к работе."""
    await apply_migrations()
    await verify_database()
    await verify_redis()


async def shutdown_runtime() -> None:
    """Закрывает соединения при остановке приложения."""
    await close_redis()
    await close_engine()
