# Спецификация проекта «Интеллектуальный ассистент продаж ИИ-услуг»

## 1. Назначение документа
Документ описывает требования, архитектуру и план реализации системы интеллектуального ассистента продаж услуг на базе искусственного интеллекта. Спецификация служит единым источником правды для команды разработки, интеграторов и заинтересованных сторон.

## 2. Цели продукта и KPI
- **Основная цель**: обеспечить полностью автоматизированную воронку продаж ИИ-услуг от первого контакта до оплаты, включая работу по каналам Avito, Telegram и сайт.
- **KPI**: среднее время ответа ≤ 3 секунд; конверсия лид → заявка ≥ 25%; автоматическая обработка ≥ 80% запросов; NPS ≥ 60; доступность сервиса ≥ 99,5%.
- **Дополнительные цели**: сокращение ручной работы менеджеров, повышение точности расчётов и скорости подготовки документов, единая база знаний и сценариев.

## 3. Роли и заинтересованные стороны
- **Клиент** (потенциальный покупатель услуг): инициирует контакт, проходит бриф, получает КП и ссылки для оплаты.
- **Менеджер по продажам**: мониторит исключения, ручные кейсы, подтверждает бронирования, получает уведомления.
- **Администратор**: управляет контентом базы знаний, тарифами, интеграциями, конфигурацией каналов.
- **Команда внедрения**: отвечает за загрузку документов, обновление прайс-листов, аудит логов.

## 4. Каналы коммуникации
1. **Avito API** (приоритетный): приём webhooks, автоответы, обновление объявлений, пересылка в Telegram, передача лидов в CRM с тегом `avito-lead`.
2. **Telegram Bot**: чат, сбор брифа, расчёт и выдача коммерческого предложения, бронирование консультаций.
3. **Сайт**: лендинг, чат-виджет, онлайн-калькулятор, формы; интеграция с Telegram и CRM.

## 5. Основные пользовательские сценарии
1. **Первичный контакт (Avito/Telegram/сайт)**: приветствие, короткая квалификация, идентификация намерения (ИИ-Менеджер, ИИ-Юрист, ИИ-Аналитик).
2. **Сбор брифа**: ассистент задаёт структурированные вопросы по отрасли, масштабу, целям, числу пользователей, интеграциям, требованиям безопасности и SLA.
3. **Расчёт стоимости**: применение формулы `base_price × coef_users × coef_integrations × coef_onprem × coef_sla × coef_deadline`, генерация пакетов «Старт», «Оптимум», «Enterprise».
4. **Подготовка документов**: формирование КП, договора и счёта в формате PDF (WeasyPrint + Jinja2), отправка пользователю и менеджеру.
5. **Обработка возражений**: использование скриптов из базы знаний, предоставление кейсов и FAQ.
6. **Бронирование консультации**: синхронизация свободных слотов через Google Calendar API, подтверждение и напоминания.
7. **Оплата**: создание лида в amoCRM, генерация ссылки ЮKassa (TTL 24 часа), отслеживание статуса платежа.
8. **Постобслуживание**: сохранение контекста диалога в Redis на 30 дней, аналитика конверсий и NPS.

## 6. Функциональные требования
### 6.1 Управление диалогом
- Идентификация пользователя и сегментация по продуктовым направлениям.
- Поддержка контекстной памяти (до 20 последних сообщений) с TTL 30 дней.
- Распознавание намерений и эмоций для адаптации сценариев.
- Динамическое ветвление сценариев в зависимости от ответов и каналов связи.

### 6.2 База знаний и RAG
- Загрузка и обработка материалов из `knowledge_base/`.
- Индексация через pgvector (1536 измерений, модель OpenAI `text-embedding-3-small`).
- Семантический поиск по услугам, кейсам, УТП, FAQ, возражениям, прайс-листам.
- Поддержка версионности документов и их обновления без перезапуска сервиса.

### 6.3 Расчёт стоимости
- Хранение базовых ставок и коэффициентов в БД.
- Поддержка трёх пакетов:
  - **Старт**: базовый функционал, облачное размещение.
  - **Оптимум**: расширенные интеграции, корпоративные SLA.
  - **Enterprise**: кастомизация, on-premise опции, выделенная поддержка.
- Автоматический пересчёт при изменении параметров брифа.
- Проверка ограничений (макс. попыток расчёта, длины сообщений).

Таблица коэффициентов:

| Параметр       | Условия                 | Коэффициент |
|----------------|-------------------------|-------------|
| Пользователи   | 1-10 / 11-50 / 51-200 / 200+ | 1.0 / 1.5 / 2.0 / 3.0 |
| Интеграции     | 0-2 / 3-5 / 6-10 / 10+        | 1.0 / 1.3 / 1.7 / 2.2 |
| Размещение     | Облако / Гибрид / On-prem     | 1.0 / 1.5 / 2.5 |
| SLA            | Стандарт / 99.5% / 99.9%      | 1.0 / 1.3 / 1.8 |
| Сроки          | Стандарт / <2 недель / <1 недели | 1.0 / 1.5 / 2.0 |

### 6.4 Генерация документов
- Шаблоны Jinja2 в каталоге `templates/`.
- Предпросмотр HTML и итоговый PDF через WeasyPrint.
- Проверка ограничений: `MAX_PDF_SIZE_MB = 10`.
- Автоматическое сохранение копий в `data/documents/` и синхронизация через `rsync`.

### 6.5 Интеграции и автоматизация
- **Avito API**: работа с REST-интерфейсом `https://api.avito.ru/`, авторизация по OAuth2 (POST `/token`, TTL 86400 секунд, обновление за час до истечения, хранение в Redis), обязательный заголовок `Authorization: Bearer {access_token}`; приоритетные эндпоинты — регистрация webhook (`POST /messenger/v3/webhook`), проверка подписки (`GET /messenger/v1/subscriptions`), отправка сообщений (`POST /messenger/v3/send`), получение чатов (`GET /messenger/v3/chats`), загрузка медиа (`POST /messenger/v3/upload_image`), просмотр сообщений (`GET /messenger/v3/chats/{chat_id}/messages`), а также Items API (метаданные объявлений, статистика, VAS); обработка rate limit с экспоненциальным бэкофом и обязательным логированием ошибок.
- Messenger API (v3) поддерживает получение списков чатов, просмотр истории, отправку текста и изображений (с предварительной загрузкой), обработку голосовых сообщений, удаление, отметку прочтения и управление чёрным списком; необходимо реализовать подписку/отписку на вебхуки, отвечающие <5 секунд, с HTTPS и валидным сертификатом. Основной вебхук сервиса: `https://YOUR_DOMAIN/api/v1/webhooks/avito/messages`, для разработки — временный публичный URL (например, ngrok). Все webhook-запросы логируются, валидируются и защищаются JWT.
- Поток авторизации: получение `CLIENT_ID` и `CLIENT_SECRET` в личном кабинете Avito, определение `USER_ID`, запрос `access_token` через `grant_type=client_credentials`, сохранение токена в Redis с TTL 86400 секунд, обновление не позднее чем за час до истечения. Rate limit значения уточняются, поэтому реализуется универсальный механизм повторов с экспоненциальной задержкой и алертированием при превышении лимитов.
- **Telegram Bot API**: webhook-режим, inline-кнопки, хранение состояний в Redis.
- **amoCRM**: создание/обновление лидов, проставление тегов источника, синхронизация статуса оплаты.
- **Google Calendar API**: чтение свободных слотов, бронирование, отмена, напоминания.
- **ЮKassa**: генерация платёжных ссылок, контроль `MAX_PAYMENT_ATTEMPTS = 3`, TTL ссылки 24 часа.
- **Email SMTP**: уведомления менеджерам и клиентам о ключевых событиях (новый лид, бронирование, оплата).
- **LLM провайдеры**: мультимодельная конфигурация (GPT-4o-mini приоритет, Claude 3.5 резерв, возможность OpenRouter).

### 6.6 Внутренние API
- FastAPI endpoints в `app/api/` для Avito, Telegram, webhooks, admin-панели.
- JWT авторизация (HS256, срок жизни 1440 минут).
- Admin endpoints для обновления контента, прайсов, шаблонов, просмотра логов.
- Ограничение скорости: `RATE_LIMIT_PER_MINUTE = 60` запросов на IP.

## 7. Интеграции и порядок реализации
1. Avito API.
2. JWT авторизация и защита webhooks.
3. OpenAI API (LLM, эмбеддинги).
4. Email SMTP.
5. Telegram Bot API.
6. amoCRM API.
7. Google Calendar API.
8. ЮKassa.

Каждый этап завершается интеграционным тестом и документированием результатов.

## 8. Архитектура решения
### 8.1 Технологический стек
- **Backend**: FastAPI (Python 3.11+), асинхронные обработчики.
- **Сервер**: Uvicorn + Gunicorn (ASGI).
- **База данных**: PostgreSQL (Supabase) с расширением pgvector.
- **Кэш и сессии**: Redis (Upstash).
- **Файловое хранилище**: `/var/data/documents` с резервным копированием через `rsync`.
- **Контейнеризация**: Docker + Docker Compose.
- **Reverse proxy**: Nginx + Certbot для SSL.

### 8.2 Логическая структура приложения (`app/`)
- `main.py` — точка входа FastAPI.
- `api/` — роутеры для каналов и админ-функций.
- `core/` — конфигурация, зависимости, логирование, безопасность, ограничения.
- `models/` — Pydantic-схемы, SQLAlchemy модели, DTO.
- `services/llm/` — провайдеры LLM, промпты, стратегия выбора модели.
- `services/rag/` — индексация, поиск, обработка контента базы знаний.
- `services/avito/`, `services/telegram/`, `services/pdf/` — клиенты и бизнес-логика каналов.
- `integrations/` — модули amoCRM, Google Calendar, ЮKassa, Email.

### 8.3 Потоки данных
1. Входящий запрос (Avito/Telegram/сайт) → FastAPI webhook → аутентификация → rate limit → обработчик канала.
2. Обработчик обращается к Redis за контекстом, к PostgreSQL за данными пользователя/лида.
3. RAG сервис извлекает релевантные фрагменты из pgvector и объединяет с LLM промптом.
4. LLM отвечает, результаты логируются и отправляются пользователю.
5. Для расчётов используется модуль стоимости; результаты сохраняются в БД.
6. При генерации документов запускается шаблонизация и выгрузка PDF с сохранением.
7. Триггеры событий инициируют интеграции (amoCRM, Calendar, ЮKassa, Email).

### 8.4 Масштабирование и устойчивость
- Поддержка до `MAX_CONCURRENT_USERS = 100`.
- Горизонтальное масштабирование через Docker Compose/Hetzner (несколько инстансов FastAPI + общий Redis/PostgreSQL).
- Graceful shutdown и перезапуск воркеров Gunicorn.
- Кэширование дорогостоящих запросов (результаты RAG, профили пользователей).

## 9. Данные и хранилища
- **PostgreSQL**: пользователи, лиды, параметры брифа, прайсы, события, шаблоны документов, статусы оплат.
- **Redis**: сессии диалогов, очереди задач, лимиты, кэширование RAG результатов.
- **Файловая система**: исходники базы знаний, сгенерированные PDF и вложения.
- **Шифрование**: персональные данные хранятся зашифрованными (AES-256) в БД и файловой системе.

## 10. Конфигурация и переменные окружения
Необходимые переменные:
`SUPABASE_URL`, `SUPABASE_KEY`, `SUPABASE_SERVICE_KEY`, `UPSTASH_REDIS_URL`, `LLM_PROVIDER`, `OPENAI_API_KEY`, `ANTHROPIC_API_KEY`, `AVITO_CLIENT_ID`, `AVITO_CLIENT_SECRET`, `AVITO_USER_ID`, `TELEGRAM_BOT_TOKEN`, `TELEGRAM_WEBHOOK_URL`, `AMOCRM_DOMAIN`, `AMOCRM_ACCESS_TOKEN`, `GOOGLE_CALENDAR_CREDENTIALS`, `YOOKASSA_SHOP_ID`, `YOOKASSA_SECRET_KEY`, `SENTRY_DSN`, `JWT_SECRET_KEY`, `JWT_ALGORITHM=HS256`, `JWT_EXPIRE_MINUTES=1440`, `ENVIRONMENT=production`, `LOG_LEVEL=INFO`, `DOCUMENTS_PATH=/var/data/documents`.

Хранение секретов — через `.env` (локально) и менеджер секретов на проде; доступ ограничен по ролям.

## 11. Ограничения и лимиты
- `MAX_PDF_SIZE_MB = 10`.
- `SESSION_TTL_DAYS = 30`.
- `MAX_CONCURRENT_USERS = 100`.
- `RATE_LIMIT_PER_MINUTE = 60` запросов на IP.
- `MAX_MESSAGE_LENGTH = 4000` символов.
- `MAX_CONTEXT_MESSAGES = 20`.
- `LLM_TIMEOUT_SECONDS = 30`.
- `MAX_RETRIES = 3` (экспоненциальная задержка).
- `MAX_PAYMENT_ATTEMPTS = 3`.
- `PAYMENT_LINK_TTL_HOURS = 24`.
- `MAX_ATTACHMENTS = 5`.

## 12. Безопасность
- JWT защита всех API и webhook-эндпоинтов, валидация подписей Avito, Telegram, ЮKassa.
- Шифрование персональных данных (AES-256) и безопасное хранение ключей.
- CORS настроен по белым спискам доменов.
- Rate limiting, защита от brute-force и replay атак.
- Логи без персональных данных, маскирование чувствительной информации.
- Регулярные проверки уязвимостей зависимостей.

## 13. Нефункциональные требования
- Время ответа: ≤ 3 сек для 95-го перцентиля.
- Доступность: ≥ 99,5% (мониторинг + резервные инстансы).
- Масштабируемость: поддержка 100 одновременных пользователей без деградации.
- Устойчивость к сбоям внешних сервисов (graceful degradation, очереди повторов).
- Соответствие требованиям к безопасности и защите данных.

## 14. Обработка ошибок и повторов
- Унифицированные коды ошибок API.
- Механизм повторов с экспоненциальной задержкой (`MAX_RETRIES = 3`) для внешних запросов.
- Очереди отложенных задач для повторной генерации документов/платежей.
- Уведомления менеджеру при критических сбоях.

## 15. Мониторинг и логирование
- **Sentry**: отслеживание ошибок, алерты в реальном времени.
- **Loguru**: структурированные JSON-логи, ротация каждые 500 МБ, хранение 10 дней.
- **Health-check** эндпоинты `/health` и `/ready`.
- Интеграция с Prometheus (опционально) для метрик производительности и бизнес-показателей.

## 16. Тестирование
- **Unit-тесты**: расчёт стоимости, RAG-поиск, генерация PDF.
- **Интеграционные тесты**: Avito webhook, Telegram webhook, amoCRM.
- **Фикстуры**: тестовые данные для брифа, прайсов, документов.
- **Mock внешних API**: стабилизация тестов.
- Цель покрытия: 60–70%.
- Автоматический запуск `pytest` в CI при каждом коммите.

## 17. Развёртывание и инфраструктура
- Hetzner VPS, Docker Compose для сервиса, БД, Redis, Nginx.
- Certbot для получения и автообновления SSL-сертификатов.
- Пайплайн: подготовка образов, миграции БД, прогрев индексов RAG, раскатка контейнеров.
- Резервное копирование: `rsync` директорий `data/documents/`, экспорт БД (pg_dump), снапшоты Redis.
- Стратегия обновлений: blue-green или rolling, обязательный бэкап перед релизом.

## 18. Управление знаниями
- Структура `knowledge_base/`: услуги, УТП, кейсы, FAQ, прайсы, политики, скрипты.
- Настройка пайплайна загрузки новых материалов (парсер → нормализация → векторизация).
- Отслеживание актуальности документов, журнал изменений.
- Поддержка нескольких языковых версий (приоритет — русский).

## 19. План дальнейших работ
- Реализация интеграций в указанном порядке с ревью после каждого этапа.
- Подготовка админ-интерфейса для управления контентом и настройками.
- Настройка аналитики (конверсия, воронка, источники трафика).
- Подготовка плана отката и плана реагирования на инциденты.

## 20. Открытые вопросы и допущения
- Требуется финализировать базовую ставку и правила скидок для расчёта стоимости.
- Необходимы макеты для лендинга и чат-виджета (ответственность команды дизайна).
- Подтвердить требования по хранению и удалению персональных данных (GDPR/локальные нормативы).
- Согласовать процессы ручной эскалации от ассистента к менеджеру.

---
Документ предназначен для использования командой разработчиков, аналитиков и интеграторов при планировании и реализации проекта.
