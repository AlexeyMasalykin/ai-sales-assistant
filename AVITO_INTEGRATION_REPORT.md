# üìä –û—Ç—á—ë—Ç: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Avito Messenger API

**–î–∞—Ç–∞:** 24 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ

---

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **Client ID:** `3YrB26STF-FoBME_mN_1`
- **Client Secret:** –ü—Ä–æ–≤–µ—Ä–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- **User ID:** `7738787`
- **–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:** `messenger:read`, `messenger:write`

### 2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ endpoints —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Avito

#### –î–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ):
```python
# –°—Ç–∞—Ä—ã–µ endpoints v3
/messenger/v3/chats
/messenger/v3/send
/messenger/v3/chats/{chat_id}/messages
```

#### –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ä–∞–±–æ—Ç–∞–µ—Ç):
```python
# –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ endpoints –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
GET  /messenger/v2/accounts/{user_id}/chats                               # –ü–æ–ª—É—á–µ–Ω–∏–µ —á–∞—Ç–æ–≤
POST /messenger/v1/accounts/{user_id}/chats/{chat_id}/messages            # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
GET  /messenger/v3/accounts/{user_id}/chats/{chat_id}/messages/           # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
POST /messenger/v3/webhook                                                 # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è webhook
POST /messenger/v1/subscriptions                                           # –°—Ç–∞—Ç—É—Å webhook
POST /messenger/v1/webhook/unsubscribe                                     # –û—Ç–ø–∏—Å–∫–∞ –æ—Ç webhook
```

### 3. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API

#### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (OAuth2 client_credentials):
```
‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ
Endpoint: POST https://api.avito.ru/token
Expires in: 86400 —Å–µ–∫—É–Ω–¥ (24 —á–∞—Å–∞)
```

#### messenger:read (—á—Ç–µ–Ω–∏–µ —á–∞—Ç–æ–≤):
```
‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —á–∞—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
Endpoint: GET /messenger/v2/accounts/{user_id}/chats
–ù–∞–π–¥–µ–Ω–æ —á–∞—Ç–æ–≤: 5
–ü—Ä–∏–º–µ—Ä—ã:
  1. Chat ID: u2i-M1ttp84ZUMlWRq6ZjnLSaw
  2. Chat ID: u2i-t82Znb0Et9p9l1RaTQK6BQ
     –û–±—ä—è–≤–ª–µ–Ω–∏–µ: "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–ª–µ–¥ –ª–∏–Ω–∑"
  3. Chat ID: u2i-3WjtEjXeHmdgyPIYLwGCDQ
     –û–±—ä—è–≤–ª–µ–Ω–∏–µ: "–ü–µ–Ω–æ–ª–∏—Ç—å–µ –ø–æ—Ä–æ–ª–æ–Ω —Å–∏–¥–µ–Ω—å—è Nissan X-Trail T31"
```

#### messenger:write (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π):
```
‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç
Endpoint: POST /messenger/v1/accounts/{user_id}/chats/{chat_id}/messages
Message ID: 3e09789f2f8d99a3bc547c281242a2ff
–¢–µ–∫—Å—Ç: "ü§ñ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç AI Sales Assistant API"
```

---

## üìù –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### `app/services/avito/client.py`
**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

1. **`send_message()`** - –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `user_id`, –æ–±–Ω–æ–≤–ª—ë–Ω endpoint –Ω–∞ v1
2. **`get_chats()`** - –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `user_id`, –æ–±–Ω–æ–≤–ª—ë–Ω endpoint –Ω–∞ v2
3. **`get_chat_messages()`** - –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `user_id`, –æ–±–Ω–æ–≤–ª—ë–Ω endpoint –Ω–∞ v3
4. **`get_webhook_status()`** - –∏–∑–º–µ–Ω—ë–Ω –º–µ—Ç–æ–¥ —Å GET –Ω–∞ POST (v1)
5. **`unregister_webhook()`** - –¥–æ–±–∞–≤–ª–µ–Ω payload —Å URL (v1)

**–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:**
- ‚úÖ Black: —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É
- ‚úÖ Flake8: 0 –æ—à–∏–±–æ–∫ (max-line-length=88)
- ‚úÖ Mypy: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–∞
- ‚úÖ Linter: –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ

---

## üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

| –¢–µ—Å—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------|----------|
| **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** | ‚úÖ | OAuth2 client_credentials —Ä–∞–±–æ—Ç–∞–µ—Ç |
| **messenger:read** | ‚úÖ | –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ (v2) |
| **messenger:write** | ‚úÖ | –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (v1) |
| **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π** | ‚ö†Ô∏è | Endpoint –æ–±–Ω–æ–≤–ª—ë–Ω (v3), —Ç—Ä–µ–±—É–µ—Ç —Ç–µ—Å—Ç–∞ |
| **Webhook** | ‚ö†Ô∏è | –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ URL –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è |

**–ò—Ç–æ–≥–æ:** 3/5 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ (60%)

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
```python
# –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å webhook
await client.register_webhook("https://your-domain.com/api/avito/webhook")

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
status = await client.get_webhook_status()
```

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RAG —Å–∏—Å—Ç–µ–º–æ–π
–û–±–Ω–æ–≤–∏—Ç—å `app/services/avito/handlers.py`:
- –ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤—ã–∑–æ–≤—ã RAG —Å–∏—Å—Ç–µ–º—ã
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `answer_engine.generate_answer()` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –ø–∞–º—è—Ç—å —á–µ—Ä–µ–∑ `session_manager`

–ü—Ä–∏–º–µ—Ä:
```python
from app.services.rag.answer import answer_engine

async def handle_text_message(chat_id: str, text: str, author_id: str) -> str:
    # –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
    answer = await answer_engine.generate_answer(text)
    return answer
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook –≤ `app/api/routes/avito.py`
- –î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω-–æ–∫—Ä—É–∂–µ–Ω–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ (Sentry)
- –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π

---

## üìö –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

- [Avito Messenger API](https://api.avito.ru/docs/api.html)
- [OAuth2 –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è](https://api.avito.ru/docs/api.html#tag/Access)
- –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: `messenger:read`, `messenger:write`

---

## ‚úÖ –í—ã–≤–æ–¥—ã

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Avito API –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**
2. **–û—Å–Ω–æ–≤–Ω—ã–µ endpoints (v1, v2, v3) –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**
3. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã**
4. **–ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∫–∞—á–µ—Å—Ç–≤–∞ (black, flake8, mypy)**
5. **–ì–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å RAG —Å–∏—Å—Ç–µ–º–æ–π –¥–ª—è —É–º–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤**

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è handlers —Å RAG –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.

