# ü™ù Avito Webhook: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–î–∞—Ç–∞:** 24 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. ‚úÖ Webhook –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ Avito
- **URL:** `https://smmassistant.online/api/v1/webhooks/avito/messages`
- **–í–µ—Ä—Å–∏—è:** v3
- **–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–µ–Ω

### 2. ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω
**–§–∞–π–ª:** `app/api/routes/avito.py` (—Å—Ç—Ä–æ–∫–∞ 26)

**Endpoint:** `POST /api/v1/webhooks/avito/messages`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç Avito
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å—å (X-Avito-Signature)
- –î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ –æ—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å 200 OK

### 3. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RAG —Å–∏—Å—Ç–µ–º–æ–π
**–§–∞–π–ª:** `app/services/avito/handlers.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `handle_text_message()` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç RAG –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö RAG
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã:**
```python
# –í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
message = "–ö–∞–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ?"

# RAG –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
answer = await answer_engine.generate_answer(message)

# –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É –≤ Avito
await client.send_message(chat_id, answer)
```

### 4. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ unregister_webhook
**–§–∞–π–ª:** `app/services/avito/webhook.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `webhook_url` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ URL –∏–∑ —Ç–µ–∫—É—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ URL –Ω–µ –Ω–∞–π–¥–µ–Ω

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```mermaid
graph LR
    A[–ö–ª–∏–µ–Ω—Ç –≤ Avito] -->|–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ| B[Avito Messenger]
    B -->|POST webhook| C[/api/v1/webhooks/avito/messages]
    C -->|–î–æ–±–∞–≤–ª—è–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å| D[Message Queue]
    D -->|Worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç| E[AvitoWebhookHandler]
    E -->|–ó–∞–ø—Ä–æ—Å –∫ RAG| F[RAG Engine]
    F -->|–ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π| G[PostgreSQL + pgvector]
    G -->|–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã| F
    F -->|–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞| H[OpenAI API]
    H -->|–û—Ç–≤–µ—Ç| E
    E -->|–û—Ç–ø—Ä–∞–≤–∫–∞| I[Avito Messenger API]
    I -->|–î–æ—Å—Ç–∞–≤–∫–∞| A
```

### –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å:

1. **–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ** –≤ —á–∞—Ç–µ Avito
2. **Avito –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook** –Ω–∞ –Ω–∞—à endpoint
3. **FastAPI –ø—Ä–∏–Ω–∏–º–∞–µ—Ç webhook** –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å—å
4. **–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å** (asyncio.Queue)
5. **Worker –±–µ—Ä—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ** –∏–∑ –æ—á–µ—Ä–µ–¥–∏
6. **Handler –≤—ã–∑—ã–≤–∞–µ—Ç RAG —Å–∏—Å—Ç–µ–º—É**:
   - –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–î
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ OpenAI
7. **–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É** —á–µ—Ä–µ–∑ Avito API
8. **–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

---

## üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ .env

```env
# –ê–≤–∏—Ç–æ API
AVITO_CLIENT_ID=3YrB26STF-FoBME_mN_1
AVITO_CLIENT_SECRET=...
AVITO_USER_ID=7738787

# –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã
AVITO_AUTO_REPLY_ENABLED=true
AVITO_RESPONSE_DELAY_SECONDS=2

# –û—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
AVITO_MAX_QUEUE_SIZE=1000
AVITO_PROCESSING_WORKERS=3
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook —Å—Ç–∞—Ç—É—Å–∞:
```python
from app.services.avito.client import AvitoAPIClient

client = AvitoAPIClient()
status = await client.get_webhook_status()
# {'subscriptions': [{'url': '...', 'version': '3'}]}
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:
```python
await client.send_message(
    chat_id="u2i-M1ttp84ZUMlWRq6ZjnLSaw",
    text="–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ RAG –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:
```python
from app.services.rag.answer import answer_engine

answer = await answer_engine.generate_answer("–ö–∞–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ?")
# –í–µ—Ä–Ω—ë—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
```

---

## üîß –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### –ü–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è webhook:
```bash
POST /api/v1/avito/webhook/register
{
  "webhook_url": "https://smmassistant.online/api/v1/webhooks/avito/messages"
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:
```bash
GET /api/v1/avito/webhook/status
```

### –£–¥–∞–ª–µ–Ω–∏–µ webhook:
```bash
DELETE /api/v1/avito/webhook/unregister
```

---

## üìù –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **app/services/avito/client.py**
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã endpoints (v1, v2, v3)
   - –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `user_id` –≤–æ –≤—Å–µ –º–µ—Ç–æ–¥—ã

2. **app/services/avito/webhook.py**
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `unregister_webhook`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ URL

3. **app/services/avito/handlers.py**
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RAG —Å–∏—Å—Ç–µ–º–æ–π
   - Fallback –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã
   - –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

4. **app/api/routes/avito.py**
   - Endpoint –¥–ª—è –ø—Ä–∏—ë–º–∞ webhook (—É–∂–µ –±—ã–ª)
   - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏

---

## ‚úÖ –°—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|-----------|--------|------------|
| **Webhook URL** | ‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω | v3, –∞–∫—Ç–∏–≤–µ–Ω |
| **Endpoint** | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | `/webhooks/avito/messages` |
| **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** | ‚úÖ OK | OAuth2 client_credentials |
| **messenger:read** | ‚úÖ OK | –ü–æ–ª—É—á–µ–Ω–∏–µ —á–∞—Ç–æ–≤ |
| **messenger:write** | ‚úÖ OK | –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π |
| **RAG –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** | ‚úÖ OK | `answer_engine.generate_answer()` |
| **Fallback** | ‚úÖ OK | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö |
| **Queue processing** | ‚úÖ OK | 3 –≤–æ—Ä–∫–µ—Ä–∞, –æ—á–µ—Ä–µ–¥—å 1000 |
| **Auto-reply** | ‚úÖ Enabled | –ó–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫ |

---

## üéâ –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ Avito Messenger —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º RAG —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–º–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã
2. –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤ RAG
3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ—Ç—Ä–∏–∫ –∏ –∞–ª–µ—Ä—Ç–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

